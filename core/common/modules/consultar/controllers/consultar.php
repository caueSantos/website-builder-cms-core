<?phpif (!defined('BASEPATH'))      exit('No direct script access allowed');require_once(COMMONPATH .        'core/lands_core.php');class consultar extends lands_core {      public $autenticacao;      public $consulta = null;      public $where;      public $retorno = 'xml';      function __construct() {            $this->load->library('session');            parent::__construct();            $this->autentica_consulta();            $this->abre_consulta();      }      function index() {            $funcao = $this->pagina_atual;            if ($this->uri->segment($this->app->Segmento_padrao_txf + 1)) {                  $this->pagina_atual = $this->uri->segment($this->app->Segmento_padrao_txf + 1);                  $funcao = ($this->uri->segment($this->app->Segmento_padrao_txf + 1));            }            if (!method_exists(__CLASS__, $funcao)) {                  $this->carrega_pagina($this->pagina_atual);            } else {//executa uma funcao que deve ser programa nesta classe.                  $this->$funcao();            }      }      function abre_consulta() {            if ($this->uri->segment($this->app->Segmento_padrao_txf + 1)) {                  $this->consulta = $this->uri->segment($this->app->Segmento_padrao_txf + 1);            } else {                  die('Sem consulta');            }            if ($this->uri->segment($this->app->Segmento_padrao_txf + 1)) {                  $this->smarty->assign('segment2', $this->uri->segment($this->app->Segmento_padrao_txf + 1));            } else {                  $this->smarty->assign('segment2', '');            }            if ($this->uri->segment($this->app->Segmento_padrao_txf + 2)) {                  $this->smarty->assign('segment3', $this->uri->segment($this->app->Segmento_padrao_txf + 2));            } else {                  $this->smarty->assign('segment3', '');            }            $this->switch_consulta();      }      function switch_consulta() {            $this->conecta_mbc($this->app->Conexoes_for);            switch ($this->consulta) {                  case 'teste_conexao':                        $this->checa_nivel_acesso(3);                        $this->where = $this->cria_where();                        $tabelas = $this->mbc->executa_sql("show tables");                        if (count($tabelas > 1)) {                              $dados['resultado'] = 'ok';                        } else {                              $dados['resultado'] = 'erro';                        }                        $dados['mensagem'] = 'Conexão realizada com sucesso.';                        break;                  case 'buscar_vendas':                        $this->checa_nivel_acesso(3);                        $this->where = $this->cria_where();                        $query_antiga = "select p.*,pp.*,c.*,ps.* from pedidos p left outer join pedidos_produtos pp on p.orders_id=pp.orders_idleft outer join clientes c on p.customers_id=c.customers_id left outer join pedidos_status ps on p.orders_status=ps.orders_status_id";                        $vendas = $this->retorna_vendas();                        if (isset($vendas[0])) {                              $dados['total'] = count($vendas);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Consultar vendas realizada com sucesso.';                              $dados['registros'] = $vendas;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  case 'buscar_clientes':                        $this->checa_nivel_acesso(3);                        $this->where = $this->cria_where();// $clientes = $this->mbc->executa_sql("select c.*,ce.* from clientes c left outer join clientes_enderecos ce on c.customers_id=ce.customers_id");                        $clientes = $this->retorna_clientes();                        if (isset($clientes[0])) {                              $dados['total'] = count($clientes);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Consultar clientes realizada com sucesso.';                              $dados['registros'] = $clientes;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  case 'buscar_status':                        $this->checa_nivel_acesso(3);                        $this->where = $this->cria_where();// $clientes = $this->mbc->executa_sql("select c.*,ce.* from clientes c left outer join clientes_enderecos ce on c.customers_id=ce.customers_id");                        $status = $this->retorna_status();                        if (isset($status[0])) {                              $dados['total'] = count($status);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Consultar status realizada com sucesso.';                              $dados['registros'] = $status;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  case 'buscar_produtos':                        $this->checa_nivel_acesso(3);                        $this->where = $this->cria_where();// $clientes = $this->mbc->executa_sql("select c.*,ce.* from clientes c left outer join clientes_enderecos ce on c.customers_id=ce.customers_id");                        $produtos = $this->retorna_produtos();                        if (isset($produtos[0])) {                              $dados['total'] = count($produtos);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Consultar produtos realizada com sucesso.';                              $dados['registros'] = $produtos;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  case 'atualizar_estoque':                        $this->checa_nivel_acesso(5);                        $produto = $this->atualiza_estoque();                        if (isset($produto[0])) {                              $dados['total'] = count($produto);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Estoque de ' . count($produto) . ' produto atualizado com sucesso.';                              $dados['registros'] = $produto;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  case 'set_produto':                        $this->checa_nivel_acesso(5);                        $produto = $this->insere_atualiza_produto();                        if (isset($produto[0])) {                              $dados['total'] = count($produto);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Produto de ' . count($produto) . ' produto atualizado com sucesso.';                              $dados['registros'] = $produto;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  case 'atualizar_status':                        $this->checa_nivel_acesso(5);                        $venda = $this->atualiza_status();                        if (isset($venda[0])) {                              $dados['total'] = count($venda);                              $dados['resultado'] = 'ok';                              $dados['mensagem'] = 'Status de ' . count($venda) . ' venda atualizado com sucesso.';                              $dados['registros'] = $venda;                        } else {                              $dados['total'] = 0;                              $dados['resultado'] = 'vazio';                              $dados['mensagem'] = 'Nenhum registro encontrado.';                        }                        break;                  default:                        $this->retorna_erro("Operação não implementada");                        die();                        break;            }            $this->retorna($dados);      }      function cria_where($funcao = null) {            $where = '';            if (isset($_REQUEST['parametros'])) {                  $vars = json_decode($_REQUEST['parametros']);                  $where = " where 1=1";                  foreach ($vars as $key => $value) {                        switch ($key) {                              case 'customers_cpf_cnpj':                                    $where.=" and $key='$value'";                                    break;                              case 'products_cod_ref':                                    $where.=" and $key='$value'";                                    break;                              case 'customers_email_address':                                    $where.=" and $key='$value'";                                    break;                              case 'antes_de':                                    $where.=" and date_purchased<'$value'";                                    break;                              case 'data':// nao fumegou                                    $where.=" and date_purchased='$value'";                                    break;                              case 'depois_de':                                    $where.=" and date_purchased>'$value'";                                    break;                              default:                                    $where.=" and $key=$value";                                    break;                        }                  }            }            return $where;      }      function atualiza_estoque() {            $id = null;            $qtd = null;            $array = array();            if (isset($_REQUEST['parametros'])) {                  $vars = json_decode($_REQUEST['parametros']);                  foreach ($vars as $key => $value) {                        switch ($key) {                              case 'products_id':                                    $id = $value;                                    break;                              case 'products_quantity':                                    $qtd = $value;                                    break;                        }                  }            }            //verifica os parâmetros            if (($qtd == null) || ($id == null)) {                  $this->retorna_erro("Parâmetros producs_id e products_quantity são OBRIGATÓRIOS");                  die();            }            //verifica se o produto existe            $registro = $this->mbc->executa_sql("select * from produtos where products_id=$id");            if (!isset($registro[0])) {                  $this->retorna_erro("Produto não encontrado");            }//$query = "update produtos set products_quantity=$qtd where products_id=$id";//products_cod_ref            $array = object_to_array($vars);            unset($array['products_id']);            $this->mbc->updateTable('produtos', $vars, 'products_id', $id);            $registro = $this->mbc->executa_sql("select * from produtos where products_id=$id");            return $registro;      }      function insere_atualiza_produto() {            ver("chegou na funcao");            $id = null;            $qtd = null;            $array = array();            if (isset($_REQUEST['parametros'])) {                  $vars = json_decode($_REQUEST['parametros']);                  foreach ($vars as $key => $value) {                        switch ($key) {                              case 'products_id':                                    $id = $value;                                    break;                              case 'products_quantity':                                    $qtd = $value;                                    break;                        }                  }            }            //verifica os parâmetros            if (($qtd == null) || ($id == null)) {                  $this->retorna_erro("Parâmetros producs_id e products_quantity são OBRIGATÓRIOS");                  die();            }            //verifica se o produto existe            $registro = $this->mbc->executa_sql("select * from produtos where products_id=$id");            if (!isset($registro[0])) {                  $this->retorna_erro("Produto não encontrado");            }//$query = "update produtos set products_quantity=$qtd where products_id=$id";//products_cod_ref            $array = object_to_array($vars);            unset($array['products_id']);            $this->mbc->updateTable('produtos', $vars, 'products_id', $id);            $registro = $this->mbc->executa_sql("select * from produtos where products_id=$id");            return $registro;      }      function retorna_status() {            //   $array = array();            $status = $this->mbc->executa_sql("select p.* from pedidos_status p " . $this->where);//            //  ver($produtos);//            foreach ($produtos as $produto) {//                  $produto->categorias = array();//                  $produto->categorias = $this->mbc->executa_sql("select c.* from categorias c left outer join produtos_categorias pc on pc.categories_id=c.categories_id where products_id=" . $produto->products_id);//                  $array[] = $produto;//            }//            return $array;            return $status;      }      function atualiza_status() {            $id = null;            $status = null;            $array = array();            if (isset($_REQUEST['parametros'])) {                  $vars = json_decode($_REQUEST['parametros']);                  foreach ($vars as $key => $value) {                        switch ($key) {                              case 'orders_id':                                    $id = $value;                                    break;                              case 'orders_status':                                    $status = $value;                                    break;                        }                  }            }            //verifica os parâmetros            if (($status == null) || ($id == null)) {                  $this->retorna_erro("Parâmetros orders_id e orders_status são OBRIGATÓRIOS");                  die();            }            //verifica se o produto existe            $registro = $this->mbc->executa_sql("select * from pedidos where orders_id=$id");            if (!isset($registro[0])) {                  $this->retorna_erro("Venda não encontrada");            }//$query = "update produtos set products_quantity=$qtd where products_id=$id";//products_cod_ref            $array = object_to_array($vars);            unset($array['orders_id']);            $this->mbc->updateTable('pedidos', $vars, 'orders_id', $id);            $registro = $this->mbc->executa_sql("select * from pedidos where orders_id=$id");            return $registro;      }      function retorna_vendas() {            $array = array();            $query = "select p.*, ps.* from pedidos p left outer join pedidos_status ps on p.orders_status=ps.orders_status_id " . $this->where;            $query.= " and payment_method!=''";            $vendas = $this->mbc->executa_sql($query);            foreach ($vendas as $venda) {                  $venda->produtos = array();                  $venda->produtos = $this->mbc->executa_sql("select * from pedidos_produtos where orders_id=" . $venda->orders_id);                  $venda->fretes = array();                  $venda->fretes = $this->mbc->executa_sql("select * from pedidos_totalizacao where orders_id=" . $venda->orders_id);                  $array[] = $venda;            }            return $array;      }      function retorna_clientes() {            $array = array();            $clientes = $this->mbc->executa_sql("select c.* from clientes c" . $this->where);            foreach ($clientes as $cliente) {                  $cliente->enderecos = array();                  $cliente->enderecos = $this->mbc->executa_sql("select * from clientes_enderecos where customers_id=" . $cliente->customers_id);                  $array[] = $cliente;            }            return $array;      }      function retorna_produtos() {            $array = array();            $produtos = $this->mbc->executa_sql("select p.* from produtos p " . $this->where);            //  ver($produtos);            foreach ($produtos as $produto) {                  $produto->categorias = array();                  $produto->categorias = $this->mbc->executa_sql("select c.* from categorias c left outer join produtos_categorias pc on pc.categories_id=c.categories_id where products_id=" . $produto->products_id);                  $array[] = $produto;            }            return $array;            //return $produtos;      }      function retorna($data) {            if (isset($_REQUEST['retorno'])) {                  $this->retorno = $_REQUEST['retorno'];            }            $this->load->library('Format');            $dados = object_to_array($data);            switch ($this->retorno) {                  case 'xml':                        echo header("Content-type: text/xml; charset=utf-8");                        $resposta = $this->format->to_xml($dados);                        print_r($resposta);                        die();                        break;                  case 'html':                        $this->smarty->assign('retorno', $dados);                        $resposta = $this->model_smarty->retorna_tpl("consultar", $this->app->Template_txf);                        print_r($resposta);                        die();                        break;                  case 'json':                        $resposta = json_encode($dados);                        print_r($resposta);                        die();                        break;                  case 'array':                        $resposta = $dados;                        print_r($resposta);                        die();                        break;            }      }      function autentica_consulta() {            $autentica = true;            if (!isset($_REQUEST['usuario'])) {                  $autentica = false;            }            if (!isset($_REQUEST['senha'])) {                  $autentica = false;            }            if ($autentica == false) {                  $this->retorna_falha_autenticacao('Usuário e senha não foram passados na requisição.');            }            $usuario = $_REQUEST['usuario'];            $senha = $_REQUEST['senha'];            if (!$this->verifica_usuario_senha($usuario, $senha))                  $this->retorna_falha_autenticacao();      }      function verifica_usuario_senha($usuario, $senha) {            $sql = "select * from usuarios where Login_txf='$usuario' and Senha_txp='$senha'";            if ($usuario != 'lands' && $senha != 'lands') {                  $sql.="and Lands_id='" . $this->app->Lands_id . "'";            }            $autentica = $this->model_banco->executa_sql($sql);            if (isset($autentica[0]->Id_int)) {                  $this->autenticacao = $autentica[0];                  return true;            }            return false;      }      function retorna_falha_autenticacao($mensagem = 'Falha de autenticação') {            $dados['resultado'] = 'erro';            $dados['mensagem'] = $mensagem;            $this->retorna($dados);      }      function retorna_erro($mensagem = 'Parâmetros inválidos') {            $dados['resultado'] = 'erro';            $dados['mensagem'] = $mensagem;            $this->retorna($dados);      }      function checa_nivel_acesso($nivel) {            if ($this->autenticacao->Nivel_sel >= $nivel) {                  return true;            } else {                  $this->retorna_erro("Você não tem permissão para acessar este metodo.");            }      }}