<?phpif (!defined('BASEPATH'))      exit('No direct script access allowed');require_once(COMMONPATH .        'core/lands_core.php');class minhafesta extends lands_core {      public $usuario;      public $simulacoes;      public $simulacao;      public $modulo = 'minhafesta';      function __construct() {            $this->load->library('session');            parent::__construct();            $this->checa_login();            $this->abre_minhas_festas();      }      function index() {            $funcao = $this->pagina_atual;            if ($this->uri->segment($this->app->Segmento_padrao_txf + 1)) {                  $this->pagina_atual = $this->uri->segment($this->app->Segmento_padrao_txf + 1);                  $funcao = ($this->uri->segment($this->app->Segmento_padrao_txf + 1));            }            if (!method_exists(__CLASS__, $funcao)) {                  $this->carrega_pagina($this->pagina_atual);            } else {//executa uma funcao que deve ser programa nesta classe.                  $this->$funcao();            }      }      function abre_minhas_festas() {            if (isset($this->session->userdata['usuario'])) {                  $this->usuario = $this->session->userdata['usuario'];            }//            $this->load->library('session');            $this->smarty->assign('sessao', $_SESSION);            $this->switch_pagina();      }      function imprimir($retorno = null) {            if (!isset($retorno))                  $this->carrega_festa();            $this->load->model('model_smarty');            $passo1 = $_SESSION['passo1'];            $this->smarty->assign('passo1', $passo1);            $passo2 = $_SESSION['passo2'];            $this->smarty->assign('passo2', $passo2);            $id_tema = $passo2->Id_int;            $tema = $this->mbc->executa_sql("select * from temas where Id_int=$id_tema");            $_SESSION['tema'] = $tema[0];            $this->smarty->assign('tema', $tema[0]);            $passo3 = $_SESSION['passo3'];            $this->smarty->assign('passo3', $passo3);            $id_festa = $passo3->Id_int;            $festa = $this->mbc->executa_sql("select * from festas where Id_int=$id_festa");            $this->smarty->assign('festa', $festa[0]);            $passo4 = $_SESSION['passo4'];            $this->smarty->assign('passo4', $passo4);            $passo5 = $_SESSION['passo5'];            $this->smarty->assign('passo5', $passo5);            $doces = $this->mbc->executa_sql("select * from cardapio where Tipo_sel='Doce'");            $salgados = $this->mbc->executa_sql("select * from cardapio where Tipo_sel='Salgado'");            foreach ($passo5 as $key => $value) {                  foreach ($doces as $doce) {                        if ($key == $doce->Id_int) {                              $doce->Quantidade = $value;                              $doc[] = $doce;                        }                  }                  foreach ($salgados as $salgado) {                        if ($key == $salgado->Id_int) {                              $salgado->Quantidade = $value;                              $salg[] = $salgado;                        }                  }            }            $this->smarty->assign('doces', $doc);            $this->smarty->assign('salgados', $salg);            $_SESSION['salgados'] = $salg;            $_SESSION['doces'] = $doc;//            $this->smarty->assign('cardapio', $cardapio);            $passo6 = $_SESSION['passo6'];            $this->smarty->assign('passo6', $passo6);            $usuario_festa = $_SESSION['usuario_festa'];            $this->smarty->assign('usuario_festa', $usuario_festa);            $sessao = $_SESSION;            $this->smarty->assign('sessao', $sessao);            if ($retorno == null) {                  echo $this->model_smarty->render_tpl('imprimir', $this->app->Template_txf);            } else {                  return $this->model_smarty->retorna_tpl('imprimir', $this->app->Template_txf);            }            die();      }      function switch_pagina() {            $this->load->library('session');            switch ($this->pagina_atual) {                  case 'novafesta' ://                        if (isset($this->session->userdata['passo1'])) {//                              $this->session->unset_userdata('passo1');//                        }//                        if (isset($this->session->userdata['passo2'])) {//                              $this->session->unset_userdata('passo2');//                        }//                        if (isset($this->session->userdata['passo3'])) {//                              $this->session->unset_userdata('passo3');//                        }//                        if (isset($this->session->userdata['passo4'])) {//                              $this->session->unset_userdata('passo4');//                        }//                        if (isset($this->session->userdata['passo5'])) {//                              $this->session->unset_userdata('passo5');//                        }//                        if (isset($this->session->userdata['passo6'])) {//                              $this->session->unset_userdata('passo6');//                        }                        if (isset($_SESSION['passo1'])) {                              unset($_SESSION['passo1']);                        }                        if (isset($_SESSION['passo2'])) {                              unset($_SESSION['passo2']);                        }                        if (isset($_SESSION['passo3'])) {                              unset($_SESSION['passo3']);                        }                        if (isset($_SESSION['passo4'])) {                              unset($_SESSION['passo4']);                        }                        if (isset($_SESSION['passo5'])) {                              unset($_SESSION['passo5']);                        }                        if (isset($_SESSION['passo6'])) {                              unset($_SESSION['passo6']);                        }                        redirect('minhafesta/postpasso1');                        break;                  case 'minhafesta' :                        $this->conecta_mbc($this->app->Conexoes_for);                        //                        ver($this->usuario);                        if ($this->usuario->Nivel_sel == 5) {                              $query = "select * from simulacoes where Estado_sel<>'CANCELADA' order by Data_festa_dat desc";                        } else {                              $query = "select * from simulacoes where Estado_sel<>'CANCELADA' and Email_cliente_sel='" . $this->usuario->Email_txf . "' order by Data_festa_dat desc";                        }                        $simulacoes = $this->mbc->executa_sql($query);//formar a tabela com os nomes originais das simulacoes.                        foreach ($simulacoes as $simu) {                              $sim = $simu;                              if ($simu->Email_cliente_sel != '') {                                    $usuario = $this->mbc->executa_sql("select * from usuarios_festa where Email_txf='$simu->Email_cliente_sel'");                                    $sim->Usuario = $usuario[0];                              }                              if ($simu->Festa_sel != '') {                                    $festa = $this->mbc->executa_sql("select * from festas where Url_amigavel_sel='$simu->Festa_sel'");                                    $sim->Festa = $festa[0];                              }                              if ($simu->Tema_sel != '') {                                    $tema = $this->mbc->executa_sql("select * from temas where Url_amigavel_sel='$simu->Tema_sel'");                                    $sim->Tema = $tema[0];                              }                              $sims[] = $sim;                        }                        $this->smarty->assign('simulacoes', $sims);                        break;                  case 'abre_festa' :                        $this->carrega_festa();                        redirect('/minhafesta/passo1');                        break;                  case 'finaliza' :                        $id = $_POST['Id_int'];                        $Festa['Estado_sel'] = 'FINALIZADA';                        $this->mbc->updateTable('simulacoes', $Festa, 'Id_int', $id);                        redirect('/minhafesta');                        break;                  case 'postpasso1' ://                        $this->session->set_userdata('passo0', 'nova');                        $_SESSION['passo0'] = 'nova';                        redirect('/minhafesta/passo1');                        break;                  case 'passo1' :                        if (!isset($_SESSION['passo0']))                              die('Acesso Inválido');//                        if (!isset($this->session->userdata['passo0'])) {//                              die('acesso inválido');//                        }//                        if (isset($this->session->userdata['passo1'])) {//                              $this->smarty->assign('passo1', $this->session->userdata['passo1']);//                        }                        if (isset($_SESSION['passo1'])) {                              $this->smarty->assign('passo1', $_SESSION['passo1']);                        }                        break;                  case 'postpasso2' :                        if (isset($_POST)) {                              $insert_array = $_POST;//                              $this->session->set_userdata('passo1', array_to_object($insert_array));                              $_SESSION['passo1'] = array_to_object($insert_array);                        } else {                              die('not is post');                        }                        redirect('/minhafesta/passo2');                        break;                  case 'passo2' :                        if (!isset($_SESSION['passo0']))                              die('Acesso Inválido');//                        if (!isset($this->session->userdata['passo0'])) {//                              die('acesso inválido');//                        }//                        if (isset($this->session->userdata['passo2'])) {//                              $this->smarty->assign('passo2', $this->session->userdata['passo2']);//                        }                        if (isset($_SESSION['passo2'])) {                              $this->smarty->assign('passo1', $_SESSION['passo2']);                        }                        $temas = $this->mbc->buscar_desc_imagens('temas', "where Ativo_sel='SIM' order by Titulo_txf");                        $this->smarty->assign('temas', $temas);                        $this->smarty->assign("sessao", $_SESSION);                        break;                  case 'postpasso3' :                        if (isset($_POST)) {                              $insert_array = $_POST;//                              $this->session->set_userdata('passo2', array_to_object($insert_array));                              $_SESSION['passo2'] = array_to_object($insert_array);                        } else {                              die('not is post');                        }                        redirect('/minhafesta/passo3');                  case 'passo3' :                        if (!isset($_SESSION['passo0']))                              die('Acesso Inválido');//                        if (!isset($this->session->userdata['passo0'])) {//                              die('acesso inválido');//                        }//                        if (isset($this->session->userdata['passo3'])) {//                              $this->smarty->assign('passo3', $this->session->userdata['passo3']);//                        }                        if (isset($_SESSION['passo3'])) {                              $this->smarty->assign('passo3', $_SESSION['passo3']);                        }                        $this->session->unset_userdata('passo4');                        $festas = $this->mbc->executa_sql("select f.* from festas f left outer join pacotes p on f.Url_amigavel_sel=p.Festa_sel where f.Ativo_sel='SIM'");                        $this->smarty->assign('festas', $festas);                        $this->smarty->assign("sessao", $_SESSION);                        break;                  case 'postpasso4' :                        if (isset($_POST)) {                              $insert_array = $_POST;//                              $this->session->set_userdata('passo3', array_to_object($insert_array));                              $_SESSION['passo3'] = array_to_object($insert_array);                        } else {                              die('not is post');                        }                        redirect('/minhafesta/passo4');                        break;                  case 'passo4' :                        if (!isset($_SESSION['passo0']))                              die('Acesso Inválido');//                        if (!isset($this->session->userdata['passo0'])) {//                              die('acesso inválido');//                        }//                        if (isset($this->session->userdata['passo4'])) {//                              $this->smarty->assign('passo4', $this->session->userdata['passo4']);//                        }                        if (isset($_SESSION['passo4'])) {                              $this->smarty->assign('passo4', $_SESSION['passo4']);                        }                        if (!isset($_SESSION['passo3']))                              die('Acesso Inválido');//                        $festa_sel = $this->session->userdata['passo3']->Festa_sel;                        $festa_sel = $_SESSION['passo3']->Festa_sel;                        $pacotes_pessoas = $this->mbc->executa_sql("select * from pacotes_pessoas where Festa_sel='$festa_sel'");                        $this->smarty->assign('pacotes_pessoas', $pacotes_pessoas);                        break;                  case 'postpasso5' :                        if (isset($_POST)) {                              $insert_array = $_POST;//                              $this->session->set_userdata('passo4', array_to_object($insert_array));                              $_SESSION['passo4'] = array_to_object($insert_array);                        } else {                              die('not is post');                        }                        redirect('/minhafesta/passo5');                        break;                  case 'passo5' :                        if (!isset($_SESSION['passo0']))                              die('Acesso Inválido');//                        if (!isset($this->session->userdata['passo0'])) {//                              die('acesso inválido');//                        }//                        if (isset($this->session->userdata['passo4'])) {//                              $this->smarty->assign('passo4', $this->session->userdata['passo4']);//                        }                        if (isset($_SESSION['passo4'])) {                              $this->smarty->assign('passo4', $_SESSION['passo4']);                        }//                        if (isset($this->session->userdata['passo5'])) {//                              $this->smarty->assign('passo5', $this->session->userdata['passo5']);//                        }                        if (isset($_SESSION['passo5'])) {                              $this->smarty->assign('passo5', $_SESSION['passo5']);                        }                        if (!isset($_SESSION['passo3'])) {                              die('Acesso Inválido');                        }//                        $festa_sel = $this->session->userdata['passo3']->Festa_sel;                        $festa_sel = $_SESSION['passo3']->Festa_sel;                        $pacotes = $this->mbc->executa_sql("select * from pacotes where Festa_sel='$festa_sel'");                        $this->smarty->assign('pacotes', $pacotes);                        $salgados = $this->mbc->executa_sql("select * from cardapio where Tipo_sel='Salgado' and Ativo_sel='SIM'");                        $this->smarty->assign('salgados', $salgados);                        $doces = $this->mbc->executa_sql("select * from cardapio where Tipo_sel='Doce' and Ativo_sel='SIM'");                        $this->smarty->assign('doces', $doces);                        break;                  case 'postpasso6' :                        if (isset($_POST)) {                              $insert_array = $_POST;//                              $this->session->set_userdata('passo5', array_to_object($insert_array));                              $_SESSION['passo5'] = array_to_object($insert_array);                        } else {                              die('not is post');                        }                        redirect('/minhafesta/passo6');                        break;                  case 'passo6' :                        if (!isset($_SESSION['passo0']))                              die('Acesso Inválido');//                        if (isset($this->session->userdata['passo6'])) {//                              $this->smarty->assign('passo6', $this->session->userdata['passo6']);//                        }                        if (isset($_SESSION['passo6'])) {                              $this->smarty->assign('passo6', $_SESSION['passo6']);                        }                        if (!isset($_SESSION['passo3']))                              die('Acesso Inválido');//                        if (!isset($this->session->userdata['passo3']))//                              die('Acesso Inválido');//                        $festa_sel = $this->session->userdata['passo3']->Festa_sel;                        $festa_sel = $_SESSION['passo3']->Festa_sel;                        $pacotes = $this->mbc->executa_sql("select * from pacotes where Festa_sel='$festa_sel'");                        $this->smarty->assign('pacotes', $pacotes);                        break;                  case 'finalizar':                        if (isset($_POST)) {                              $insert_array = $_POST;                              $objeto = array_to_object($insert_array);//                              $this->session->set_userdata('passo6', array_to_object($insert_array));                              $_SESSION['passo6'] = array_to_object($insert_array);                              if ($_SESSION['passo0'] == 'nova') {//                              $festa['Email_cliente_sel'] = $_SESSION['usuario']->Email_txf;                                    $festa['Email_cliente_sel'] = $this->session->userdata['usuario']->Email_txf;                              }                              $festa['Nome_crianca_txf'] = $_SESSION['passo1']->Nome_crianca_txf;                              $festa['Data_nascimento_dat'] = $_SESSION['passo1']->Data_nascimento_dat;                              $festa['Data_festa_dat'] = $_SESSION['passo1']->Data_festa_dat;                              $festa['Horario_txf'] = $_SESSION['passo1']->Horario_txf;                              $festa['Local_sel'] = $_SESSION['passo1']->Local_sel;                              $festa['Tema_sel'] = $_SESSION['passo2']->Tema_sel;                              $festa['Festa_sel'] = $_SESSION['passo3']->Festa_sel;                              $festa['Bebidas_txf'] = $_SESSION['passo5']->Bebidas_txf;                              $festa['passo1'] = json_encode($_SESSION['passo1']);                              $festa['passo2'] = json_encode($_SESSION['passo2']);                              $festa['passo3'] = json_encode($_SESSION['passo3']);                              $festa['passo4'] = json_encode($_SESSION['passo4']);                              $festa['passo5'] = json_encode($_SESSION['passo5']);                              $festa['passo6'] = json_encode($_SESSION['passo6']);                              $this->conecta_mbc($this->app->Conexoes_for);                              $this->envia_email($festa);                              if ($_SESSION['passo0'] == 'nova') {                                    if ($this->mbc->db_insert("simulacoes", $festa)) {                                                                              } else {                                          redirect('/minhfest/passo6');                                    }                              } else {                                    $id = $_SESSION['passo0'];                                    if ($this->mbc->updateTable("simulacoes", $festa, 'Id_int', $id)) {                                                                              } else {                                          redirect('/minhfest/passo6');                                    }                              }                        } else {                              die('not is post');                        }                        break;                  case 'editar_cadastro':                        $user_id = $this->session->userdata['usuario']->Id_int;                        $user = $this->mbc->executa_sql("select * from usuarios_festa where Id_int=$user_id");                        if (!isset($user[0]->Id_int))                              die('Erro ao editar usuario, usuario de id ' . $user_id . ' nao foi encontrado');                        $this->smarty->assign('user', $user[0]);                        break;                  default:                        break;            }            $this->smarty->assign("sessao_ci", $this->session->all_userdata());            $this->smarty->assign("sessao", $_SESSION);            $this->model_smarty->carrega_bloco('passos', 'passos', $this->app->Template_txf);      }      function envia_email($festa = null) {            if ($_SESSION['passo0'] == 'nova') {                  $_SESSION['usuario_festa'] = $this->session->userdata['usuario'];            }//            ver($_SESSION);//            if (isset($_SESSION['usuario_festa'])) {//                  unset($_SESSION['usuario_festa']);//            }//          $_SESSION['usuario_festa'] = $this->session->userdata['usuario'];            $config = $this->mbc->executa_sql("select * from configuracoes where Ativo_sel='SIM'");            $administradores = '';            foreach ($config as $conf) {                  $administradores.=$conf->Emails_festas_txf . ',';            }            $contato['Nome_txf'] = $_SESSION['usuario_festa']->Nome_txf;            $contato['Email_txf'] = $_SESSION['usuario_festa']->Email_txf;            $contato['Destinatario_txf'] = $administradores;            if ($_SESSION['passo0'] == 'nova') {                  $contato['Assunto_txf'] = 'Novo orçamento - Monte sua Festa - Parkgirassol';            } else {                  $contato['Assunto_txf'] = 'Festa alterada - Parkgirassol';            }            $contato['Mensagem_txa'] = $this->imprimir('retorno');                              $this->load->model('model_mail');//            $this->model_mail->inicializa($this->app);             $this->model_mail->inicializa($this->app,$this->cliente);//            ver();            $this->model_mail->envia_email_novo($contato, TRUE);      }      function carrega_festa() {            if (!isset($_POST['Id_int'])) {                  die('Id não passado por post');            }            $id = $_POST['Id_int'];            $festa = $this->mbc->executa_sql("select * from simulacoes where Id_int=$id");            $usuario = $this->mbc->executa_sql("select * from usuarios_festa where Email_txf='" . $festa[0]->Email_cliente_sel . "'");            if (isset($_SESSION['usuario_festa'])) {                  unset($_SESSION['usuario_festa']);            }            $_SESSION['usuario_festa'] = $usuario[0];//                        if (isset($this->session->userdata['passo0'])) {//                              $this->session->unset_userdata('passo0');//                        }//                        $this->session->set_userdata('passo0', $id);            if (isset($_SESSION['passo0'])) {                  unset($_SESSION['passo0']);            }            $_SESSION['passo0'] = $id;//                        if (isset($this->session->userdata['passo1'])) {//                              $this->session->unset_userdata('passo1');//                        }//                        $this->session->set_userdata('passo1', json_decode($festa[0]->passo1));            if (isset($_SESSION['passo1'])) {                  unset($_SESSION['passo1']);            }            $_SESSION['passo1'] = json_decode($festa[0]->passo1);//                        if (isset($this->session->userdata['passo2'])) {//                              $this->session->unset_userdata('passo2');//                        }////                        $this->session->set_userdata('passo2', json_decode($festa[0]->passo2));            if (isset($_SESSION['passo2'])) {                  unset($_SESSION['passo2']);            }            $_SESSION['passo2'] = json_decode($festa[0]->passo2);//                        if (isset($this->session->userdata['passo3'])) {//                              $this->session->unset_userdata('passo3');//                        }////                        $this->session->set_userdata('passo3', json_decode($festa[0]->passo3));            if (isset($_SESSION['passo3'])) {                  unset($_SESSION['passo3']);            }            $_SESSION['passo3'] = json_decode($festa[0]->passo3);//                        if (isset($this->session->userdata['passo4'])) {//                              $this->session->unset_userdata('passo4');//                        }////                        $this->session->set_userdata('passo4', json_decode($festa[0]->passo4));            if (isset($_SESSION['passo4'])) {                  unset($_SESSION['passo4']);            }            $_SESSION['passo4'] = json_decode($festa[0]->passo4);//                        if (isset($this->session->userdata['passo5'])) {//                              $this->session->unset_userdata('passo5');//                        }////                        $this->session->set_userdata('passo5', json_decode($festa[0]->passo5));            if (isset($_SESSION['passo5'])) {                  unset($_SESSION['passo5']);            }            $_SESSION['passo5'] = json_decode($festa[0]->passo5);            if (isset($_SESSION['passo6'])) {                  unset($_SESSION['passo6']);            }//                        if (isset($this->session->userdata['passo6'])) {//                              $this->session->unset_userdata('passo6');//                        }//                        $this->session->set_userdata('passo6', json_decode($festa[0]->passo6));            $_SESSION['passo6'] = json_decode($festa[0]->passo6);      }}